#!/usr/bin/env bash
#
# Plaster - Cross-platform clipboard service client
# A FILO (First In, Last Out) clipboard that stores multiple entries
#

set -euo pipefail

# Default values
PLASTER_CONFIG="${HOME}/.plaster/config.yaml"
SERVER_URL="http://localhost:9321"
API_KEY=""
HELP_TEXT="Usage: plaster [OPTION]

A FILO clipboard service client.

OPTIONS:
  (no args)              Get the latest clipboard entry
  -l, --list             List all clipboard entries (first 50 chars each)
  -n, --entry <index>    Get specific clipboard entry by index
  -c, --clear            Clear all clipboard entries
  --config <path>        Use custom config file path
  -h, --help             Show this help message

EXAMPLES:
  echo 'my text' | plaster        # Push text to clipboard
  plaster                         # Get latest entry
  plaster --list                  # List all entries
  plaster -n 3                    # Get 3rd entry
  plaster --clear                 # Clear clipboard
"

# Function to generate a new API key from server
generate_api_key() {
    local response
    response=$(curl -s -X POST "$SERVER_URL/auth/generate" \
        -H "Content-Type: application/json" 2>&1)

    if echo "$response" | jq -e '.api_key' > /dev/null 2>&1; then
        echo "$response" | jq -r '.api_key'
    else
        echo "Error: Failed to generate API key" >&2
        exit 1
    fi
}

# Function to regenerate API key (when expired)
regenerate_api_key() {
    local new_key
    new_key=$(generate_api_key)
    API_KEY="$new_key"

    # Update config file
    sed -i.bak "s/api_key:.*/api_key: \"$new_key\"/" "$PLASTER_CONFIG"
    rm -f "$PLASTER_CONFIG.bak"

    echo "✓ New API key generated: $new_key" >&2
}

# Function to load configuration
load_config() {
    if [[ ! -f "$PLASTER_CONFIG" ]]; then
        # Create config directory
        mkdir -p "$(dirname "$PLASTER_CONFIG")"

        # Generate new API key
        echo "Generating new API key..." >&2
        API_KEY=$(generate_api_key)

        # Create config file
        cat > "$PLASTER_CONFIG" << EOF
# Plaster Configuration File
# Auto-generated on first use

server_url: "$SERVER_URL"
api_key: "$API_KEY"
port: 9321
max_entries: 100
persistence: true
backup_file: "~/.plaster/backup.json"
max_entry_size_mb: 10
max_total_size_mb: 500
rate_limit_requests: 100
rate_limit_window_seconds: 60
EOF
        echo "✓ Configuration created at $PLASTER_CONFIG" >&2
        echo "✓ API Key: $API_KEY" >&2
    fi

    # Extract values from YAML
    SERVER_URL=$(grep "server_url:" "$PLASTER_CONFIG" | head -1 | sed 's/.*: //' | tr -d ' "' || echo "http://localhost:9321")
    API_KEY=$(grep "api_key:" "$PLASTER_CONFIG" | head -1 | sed 's/.*: //' | tr -d ' "' || echo "")

    if [[ -z "$API_KEY" ]]; then
        echo "Error: No API key found in config. Please regenerate config." >&2
        exit 1
    fi
}

# Function to check if stdin is being piped
has_stdin() {
    [[ ! -t 0 ]]
}

# Function to show help
show_help() {
    echo "$HELP_TEXT"
}

# Function to push text
push_text() {
    local text="$1"
    local response
    local http_code
    response=$(curl -s -w "\n%{http_code}" -X POST "$SERVER_URL/push" \
        -H "Content-Type: application/json" \
        -H "X-API-Key: $API_KEY" \
        -d "{\"text\": $(echo "$text" | jq -Rs .)}" 2>&1)

    http_code=$(echo "$response" | tail -n 1)
    response=$(echo "$response" | sed '$d')

    # Check for expired/invalid key (401)
    if [[ "$http_code" == "401" ]]; then
        echo "API key expired. Generating new one..." >&2
        regenerate_api_key
        # Retry with new key
        push_text "$text"
        return
    fi

    if echo "$response" | grep -q "status.*ok"; then
        echo "✓ Text pushed to clipboard" >&2
    else
        echo "Error: Failed to push text" >&2
        echo "$response" >&2
        exit 1
    fi
}

# Helper to make API calls with 401 handling
api_call() {
    local method="$1"
    local endpoint="$2"
    local data="$3"
    local response
    local http_code

    if [[ -z "$data" ]]; then
        response=$(curl -s -w "\n%{http_code}" -X "$method" "$SERVER_URL$endpoint" \
            -H "X-API-Key: $API_KEY" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" -X "$method" "$SERVER_URL$endpoint" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: $API_KEY" \
            -d "$data" 2>&1)
    fi

    http_code=$(echo "$response" | tail -n 1)
    response=$(echo "$response" | sed '$d')

    # Check for expired key
    if [[ "$http_code" == "401" ]]; then
        echo "API key expired. Generating new one..." >&2
        regenerate_api_key
        # Retry with new key
        api_call "$method" "$endpoint" "$data"
        return
    fi

    echo "$response"
}

# Function to get latest entry
get_latest() {
    local response
    response=$(api_call GET /peek)

    if echo "$response" | grep -q '"status".*"ok"'; then
        echo "$response" | jq -r '.text'
    else
        echo "Error: Failed to get clipboard entry" >&2
        echo "$response" >&2
        exit 1
    fi
}

# Function to list all entries
list_entries() {
    local response
    response=$(curl -s -X GET "$SERVER_URL/list" \
        -H "X-API-Key: $API_KEY" 2>&1)

    if echo "$response" | grep -q '"status".*"ok"'; then
        local count
        count=$(echo "$response" | jq -r '.count')
        echo "Clipboard entries ($count total):" >&2
        echo "$response" | jq -r '.entries[] | ., ""' | nl
    else
        echo "Error: Failed to list entries" >&2
        echo "$response" >&2
        exit 1
    fi
}

# Function to get specific entry
get_entry() {
    local index=$1
    local response
    response=$(curl -s -X GET "$SERVER_URL/entry/$index" \
        -H "X-API-Key: $API_KEY" 2>&1)

    if echo "$response" | grep -q '"status".*"ok"'; then
        echo "$response" | jq -r '.text'
    else
        echo "Error: Failed to get entry at index $index" >&2
        echo "$response" >&2
        exit 1
    fi
}

# Function to clear clipboard
clear_clipboard() {
    local response
    response=$(curl -s -X DELETE "$SERVER_URL/clear" \
        -H "X-API-Key: $API_KEY" 2>&1)

    if echo "$response" | grep -q '"status".*"ok"'; then
        echo "✓ Clipboard cleared" >&2
    else
        echo "Error: Failed to clear clipboard" >&2
        echo "$response" >&2
        exit 1
    fi
}

# Main logic
main() {
    load_config

    # Check if text is being piped in
    if has_stdin; then
        # Read all stdin and push it
        local input
        input=$(cat)
        push_text "$input"
        return
    fi

    # Parse command-line arguments
    if [[ $# -eq 0 ]]; then
        # No arguments - get latest entry
        get_latest
    else
        case "$1" in
            -h|--help)
                show_help
                ;;
            -l|--list)
                list_entries
                ;;
            -n|--entry)
                if [[ $# -lt 2 ]]; then
                    echo "Error: -n/--entry requires an index argument" >&2
                    exit 1
                fi
                get_entry "$2"
                ;;
            -c|--clear)
                clear_clipboard
                ;;
            --config)
                if [[ $# -lt 2 ]]; then
                    echo "Error: --config requires a path argument" >&2
                    exit 1
                fi
                PLASTER_CONFIG="$2"
                load_config
                shift 2
                # Continue processing with remaining args
                if [[ $# -eq 0 ]]; then
                    get_latest
                fi
                ;;
            *)
                echo "Error: Unknown option '$1'" >&2
                show_help
                exit 1
                ;;
        esac
    fi
}

main "$@"
